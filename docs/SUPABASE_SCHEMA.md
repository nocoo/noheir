# Supabase Database Schema

This document describes the Supabase PostgreSQL database schema for the Personal Finance Management application.

---

## Table: `transactions`

Stores financial transaction records for each user.

### SQL Definition

```sql
create table public.transactions (
  id uuid not null default gen_random_uuid() primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  date text not null,
  year integer not null,
  month integer not null,
  day integer not null,
  primary_category text not null,
  secondary_category text,
  tertiary_category text not null,
  amount numeric not null,
  type text not null check (type in ('income', 'expense', 'transfer')),
  account text not null,
  currency text not null,
  tags text[] not null default '{}',
  note text,
  raw_index integer,
  has_secondary_mapping boolean,
  created_at timestamp with time zone not null default now()
);

-- Indexes for performance
create index transactions_user_id_idx on public.transactions(user_id);
create index transactions_year_idx on public.transactions(year);
create index transactions_date_idx on public.transactions(date);
```

### Row Level Security (RLS) Policies

```sql
-- Enable RLS
alter table public.transactions enable row level security;

-- Users can only read their own transactions
create policy "Users can read own transactions"
on public.transactions for select
using (auth.uid() = user_id);

-- Users can insert their own transactions
create policy "Users can insert own transactions"
on public.transactions for insert
with check (auth.uid() = user_id);

-- Users can update their own transactions
create policy "Users can update own transactions"
on public.transactions for update
using (auth.uid() = user_id);

-- Users can delete their own transactions
create policy "Users can delete own transactions"
on public.transactions for delete
using (auth.uid() = user_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | uuid | Primary key, auto-generated |
| `user_id` | uuid | Foreign key to auth.users, identifies the owner |
| `date` | text | Transaction date in YYYY-MM-DD format |
| `year` | integer | Year extracted from date for faster filtering |
| `month` | integer | Month (1-12) for faster filtering |
| `day` | integer | Day of month for faster filtering |
| `primary_category` | text | Main category (e.g., "餐饮", "交通") |
| `secondary_category` | text | Sub-category, can be null |
| `tertiary_category` | text | Specific transaction type |
| `amount` | numeric | Transaction amount |
| `type` | text | Transaction type: 'income', 'expense', or 'transfer' |
| `account` | text | Account name (e.g., "招商银行", "支付宝") |
| `currency` | text | Currency code (e.g., "CNY") |
| `tags` | text[] | Array of tags for categorization |
| `note` | text | Optional notes/description |
| `raw_index` | integer | Original row index from CSV import |
| `has_secondary_mapping` | boolean | Whether secondary category mapping exists |
| `created_at` | timestamp | Record creation timestamp |

---

## Table: `settings`

Stores user-specific application settings and preferences.

### SQL Definition

```sql
create table public.settings (
  id bigint generated by default as identity not null primary key,
  created_at timestamp with time zone not null default now(),
  owner_id uuid references auth.users(id) on delete cascade,
  site_name text not null default '',
  settings jsonb not null default '{}'
);

-- Index for performance
create index settings_owner_id_idx on public.settings(owner_id);
```

### Row Level Security (RLS) Policies

```sql
-- Enable RLS
alter table public.settings enable row level security;

-- Users can read their own settings
create policy "Users can read own settings"
on public.settings for select
using (auth.uid() = owner_id);

-- Users can insert their own settings
create policy "Users can insert own settings"
on public.settings for insert
with check (auth.uid() = owner_id);

-- Users can update their own settings
create policy "Users can update own settings"
on public.settings for update
using (auth.uid() = owner_id);

-- Users can delete their own settings
create policy "Users can delete own settings"
on public.settings for delete
using (auth.uid() = owner_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | bigint | Primary key, auto-increment |
| `created_at` | timestamp | Record creation timestamp |
| `owner_id` | uuid | Foreign key to auth.users, identifies the owner |
| `site_name` | text | Custom site name displayed in UI |
| `settings` | jsonb | JSON object storing user preferences |

### `settings` JSONB Schema

The `settings` column contains a JSON object with the following structure:

```typescript
interface UserSettings {
  // Color scheme: 'default' or 'swapped'
  colorScheme: 'default' | 'swapped';

  // Active income detection settings
  activeIncome: {
    enabled: boolean;
    categories: string[];  // Categories considered as active income
  };

  // Savings rate calculation settings
  savingsRate: {
    includeActiveIncome: boolean;  // Whether to include active income in savings rate
  };
}
```

---

## Important Notes

### Supabase Query Limitations

Supabase has a default limit of **1000 rows** per query. When fetching data:

1. **Use `.range()` for pagination**:
   ```typescript
   const { data } = await supabase
     .from('transactions')
     .select('*')
     .range(0, 999);
   ```

2. **Batch fetch for large datasets**:
   ```typescript
   let allRows = [];
   let offset = 0;
   const batchSize = 1000;
   let hasMore = true;

   while (hasMore) {
     const { data } = await supabase
       .from('transactions')
       .select('*')
       .range(offset, offset + batchSize - 1);

     if (data && data.length > 0) {
       allRows = allRows.concat(data);
       offset += batchSize;
       hasMore = data.length === batchSize;
     } else {
       hasMore = false;
     }
   }
   ```

3. **Use specific column selection** when only needing metadata:
   ```typescript
   // To get distinct years efficiently
   const { data } = await supabase
     .from('transactions')
     .select('year');
   ```

### TypeScript Type Mappings

The database schema maps to TypeScript interfaces in `src/hooks/useSupabaseTransactions.ts`:

```typescript
interface SupabaseTransactionRow {
  id: string;
  user_id: string;
  date: string;
  year: number;
  month: number;
  day: number;
  primary_category: string;
  secondary_category: string | null;
  tertiary_category: string;
  amount: number;
  type: 'income' | 'expense' | 'transfer';
  account: string;
  currency: string;
  tags: string[];
  note: string | null;
  raw_index: number | null;
  has_secondary_mapping: boolean | null;
  created_at: string;
}
```

---

## Setup Instructions

1. Go to Supabase project → SQL Editor
2. Run the SQL statements above to create tables and enable RLS
3. Configure environment variables in `.env.local`:
   ```
   VITE_SUPABASE_URL=your-project-url
   VITE_SUPABASE_ANON_KEY=your-anon-key
   ```
