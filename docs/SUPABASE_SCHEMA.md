# Supabase Database Schema

This document describes the Supabase PostgreSQL database schema for the Personal Finance Management application.

**Project**: finance-manager
**Reference**: ovglfjkumvzxyhklohst
**Last Updated**: 2025-01-01

---

## Table Overview

| Table | Description |
|-------|-------------|
| `transactions` | Financial transaction records (income/expense/transfer) |
| `settings` | User-specific application settings and preferences |
| `financial_products` | Financial products (funds, insurance, deposits, etc.) |
| `capital_units` | Capital allocation units linked to products |

---

## Table: `transactions`

Stores financial transaction records for each user.

### SQL Definition

```sql
create table public.transactions (
  id uuid default gen_random_uuid() not null primary key,
  user_id uuid default auth.uid() not null references auth.users(id) on delete cascade,
  date text not null,
  year integer not null,
  month integer not null,
  day integer not null,
  primary_category text not null,
  secondary_category text,
  tertiary_category text not null,
  amount numeric not null,
  type text not null check (type in ('income', 'expense', 'transfer')),
  account text not null,
  currency text default '人民币' not null,
  tags text[] default '{}' not null,
  note text,
  raw_index integer,
  has_secondary_mapping boolean default true,
  created_at timestamp with time zone default now()
);

-- Indexes
create index idx_transactions_user_year on public.transactions(user_id, year);
create index idx_transactions_date on public.transactions(date);
create index idx_transactions_type on public.transactions(type);
create index idx_transactions_primary_category on public.transactions(primary_category);
```

### Row Level Security (RLS) Policies

```sql
alter table public.transactions enable row level security;

create policy "Users can view own transactions"
  on public.transactions for select
  using (auth.uid() = user_id);

create policy "Users can insert own transactions"
  on public.transactions for insert
  with check (auth.uid() = user_id);

create policy "Users can update own transactions"
  on public.transactions for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "Users can delete own transactions"
  on public.transactions for delete
  using (auth.uid() = user_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | uuid | Primary key, auto-generated |
| `user_id` | uuid | Foreign key to auth.users, identifies the owner |
| `date` | text | Transaction date in YYYY-MM-DD format |
| `year` | integer | Year extracted from date for faster filtering |
| `month` | integer | Month (1-12) for faster filtering |
| `day` | integer | Day of month for faster filtering |
| `primary_category` | text | Main category (e.g., "餐饮", "交通") |
| `secondary_category` | text | Sub-category, can be null |
| `tertiary_category` | text | Specific transaction type |
| `amount` | numeric | Transaction amount |
| `type` | text | Transaction type: 'income', 'expense', or 'transfer' |
| `account` | text | Account name (e.g., "招商银行", "支付宝") |
| `currency` | text | Currency code (default: "人民币") |
| `tags` | text[] | Array of tags for categorization |
| `note` | text | Optional notes/description |
| `raw_index` | integer | Original row index from CSV import |
| `has_secondary_mapping` | boolean | Whether secondary category mapping exists |
| `created_at` | timestamp | Record creation timestamp |

---

## Table: `settings`

Stores user-specific application settings and preferences.

### SQL Definition

```sql
create table public.settings (
  id bigint generated by default as identity not null primary key,
  created_at timestamp with time zone default now() not null,
  owner_id uuid references auth.users(id) on delete cascade,
  site_name text default '' not null,
  settings jsonb default '{}' not null
);
```

### Row Level Security (RLS) Policies

```sql
alter table public.settings enable row level security;

create policy "Users can read own data"
  on public.settings for select
  to authenticated
  using (auth.uid() = owner_id);

create policy "Users can insert own data"
  on public.settings for insert
  to authenticated
  with check (auth.uid() = owner_id);

create policy "Users can update own data"
  on public.settings for update
  using (auth.uid() = owner_id)
  with check (auth.uid() = owner_id);

create policy "Users can delete own data"
  on public.settings for delete
  to authenticated
  using (auth.uid() = owner_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | bigint | Primary key, auto-increment |
| `created_at` | timestamp | Record creation timestamp |
| `owner_id` | uuid | Foreign key to auth.users, identifies the owner |
| `site_name` | text | Custom site name displayed in UI |
| `settings` | jsonb | JSON object storing user preferences |

### `settings` JSONB Schema

```typescript
interface UserSettings {
  // Color scheme: 'default' or 'swapped'
  colorScheme: 'default' | 'swapped';

  // Active income detection settings
  activeIncome: {
    enabled: boolean;
    categories: string[];  // Categories considered as active income
  };

  // Savings rate calculation settings
  savingsRate: {
    includeActiveIncome: boolean;  // Whether to include active income in savings rate
  };
}
```

---

## Table: `financial_products`

Stores financial product information (funds, insurance, deposits, etc.).

### SQL Definition

```sql
create table public.financial_products (
  id uuid default extensions.uuid_generate_v4() not null primary key,
  user_id uuid default auth.uid() not null references auth.users(id) on delete cascade,
  name text not null,
  code text,
  channel text,
  category text,
  currency text default 'CNY' not null,
  lock_period_days integer default 0,
  annual_return_rate numeric(5,2),
  created_at timestamp with time zone default now(),
  constraint financial_products_category_check
    check (category in (
      '养老年金', '储蓄保险', '混债基金', '债券基金', '货币基金',
      '股票基金', '指数基金', '宽基指数', '私募基金', '定期存款',
      '理财产品', '现金+'
    )),
  constraint financial_products_channel_check
    check (channel in (
      '招商银行', '平安银行', '微众银行', '支付宝', '招银香港',
      '光大永明', '中信建投'
    )),
  constraint financial_products_currency_check
    check (currency in ('CNY', 'USD', 'HKD'))
);

-- Indexes
create index idx_financial_products_user on public.financial_products(user_id);
```

### Row Level Security (RLS) Policies

```sql
alter table public.financial_products enable row level security;

create policy "products_select_policy"
  on public.financial_products for select
  using (auth.uid() = user_id);

create policy "products_insert_policy"
  on public.financial_products for insert
  with check (auth.uid() = user_id);

create policy "products_update_policy"
  on public.financial_products for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "products_delete_policy"
  on public.financial_products for delete
  using (auth.uid() = user_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | uuid | Primary key, auto-generated |
| `user_id` | uuid | Foreign key to auth.users, identifies the owner |
| `name` | text | Product name |
| `code` | text | Product code |
| `channel` | text | Purchase channel (e.g., "招商银行", "支付宝") |
| `category` | text | Product category (e.g., "货币基金", "养老年金") |
| `currency` | text | Currency: CNY, USD, or HKD |
| `lock_period_days` | integer | Lock period in days |
| `annual_return_rate` | numeric(5,2) | Annual return rate (e.g., 3.50 for 3.5%) |
| `created_at` | timestamp | Record creation timestamp |

### Allowed Values

**Category**: `'养老年金'`, `'储蓄保险'`, `'混债基金'`, `'债券基金'`, `'货币基金'`, `'股票基金'`, `'指数基金'`, `'宽基指数'`, `'私募基金'`, `'定期存款'`, `'理财产品'`, `'现金+'`

**Channel**: `'招商银行'`, `'平安银行'`, `'微众银行'`, `'支付宝'`, `'招银香港'`, `'光大永明'`, `'中信建投'`

**Currency**: `'CNY'`, `'USD'`, `'HKD'`

---

## Table: `capital_units`

Stores capital allocation units linked to financial products.

### SQL Definition

```sql
create table public.capital_units (
  id uuid default extensions.uuid_generate_v4() not null primary key,
  user_id uuid default auth.uid() not null references auth.users(id) on delete cascade,
  unit_code text not null,
  amount numeric(12,2) not null,
  currency text default 'CNY' not null,
  status text default '已成立' not null,
  strategy text,
  tactics text,
  product_id uuid references public.financial_products(id) on delete set null,
  start_date date,
  end_date date,
  created_at timestamp with time zone default now(),
  constraint capital_units_status_check
    check (status in ('已成立', '计划中', '筹集中', '已归档')),
  constraint capital_units_strategy_check
    check (strategy in (
      '远期理财', '美元资产', '36存单', '长期理财',
      '短期理财', '中期理财', '进攻计划', '麻麻理财'
    )),
  constraint capital_units_tactics_check
    check (tactics in (
      '养老年金', '个人养老金', '定期存款', '理财产品', '现金产品',
      '债券基金', '偏股基金', '稳健理财', '增额寿险', '货币基金'
    ))
);

-- Indexes
create index idx_capital_units_user on public.capital_units(user_id);
create index idx_capital_units_product on public.capital_units(product_id);
```

### Row Level Security (RLS) Policies

```sql
alter table public.capital_units enable row level security;

create policy "units_select_policy"
  on public.capital_units for select
  using (auth.uid() = user_id);

create policy "units_insert_policy"
  on public.capital_units for insert
  with check (auth.uid() = user_id);

create policy "units_update_policy"
  on public.capital_units for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "units_delete_policy"
  on public.capital_units for delete
  using (auth.uid() = user_id);
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `id` | uuid | Primary key, auto-generated |
| `user_id` | uuid | Foreign key to auth.users, identifies the owner |
| `unit_code` | text | Unit identifier code |
| `amount` | numeric(12,2) | Capital amount |
| `currency` | text | Currency code (default: CNY) |
| `status` | text | Status: '已成立', '计划中', '筹集中', or '已归档' |
| `strategy` | text | Investment strategy (e.g., "远期理财", "美元资产") |
| `tactics` | text | Investment tactics (e.g., "养老年金", "定期存款") |
| `product_id` | uuid | Foreign key to financial_products, nullable |
| `start_date` | date | Unit start date |
| `end_date` | date | Unit end date |
| `created_at` | timestamp | Record creation timestamp |

### Allowed Values

**Status**: `'已成立'`, `'计划中'`, `'筹集中'`, `'已归档'`

**Strategy**: `'远期理财'`, `'美元资产'`, `'36存单'`, `'长期理财'`, `'短期理财'`, `'中期理财'`, `'进攻计划'`, `'麻麻理财'`

**Tactics**: `'养老年金'`, `'个人养老金'`, `'定期存款'`, `'理财产品'`, `'现金产品'`, `'债券基金'`, `'偏股基金'`, `'稳健理财'`, `'增额寿险'`, `'货币基金'`

---

## Database Functions

### `get_units_with_products()`

Returns capital units with associated product details.

```sql
create or replace function public.get_units_with_products()
returns table(
  id uuid,
  user_id uuid,
  unit_code text,
  amount numeric,
  currency text,
  status text,
  strategy text,
  tactics text,
  product_id uuid,
  start_date date,
  end_date date,
  created_at timestamp with time zone,
  product jsonb
)
language plpgsql
set search_path to 'public'
as $$
begin
  return query
  select
    u.id, u.user_id, u.unit_code, u.amount, u.currency,
    u.status, u.strategy, u.tactics, u.product_id,
    u.start_date, u.end_date, u.created_at,
    to_jsonb(p) as product
  from capital_units u
  left join financial_products p on u.product_id = p.id
  where u.user_id = auth.uid()
  order by u.created_at desc;
end;
$$;
```

**Usage**:
```typescript
const { data } = await supabase.rpc('get_units_with_products');
```

---

## Important Notes

### Supabase Query Limitations

Supabase has a default limit of **1000 rows** per query. When fetching data:

1. **Use `.range()` for pagination**:
   ```typescript
   const { data } = await supabase
     .from('transactions')
     .select('*')
     .range(0, 999);
   ```

2. **Batch fetch for large datasets**:
   ```typescript
   let allRows = [];
   let offset = 0;
   const batchSize = 1000;
   let hasMore = true;

   while (hasMore) {
     const { data } = await supabase
       .from('transactions')
       .select('*')
       .range(offset, offset + batchSize - 1);

     if (data && data.length > 0) {
       allRows = allRows.concat(data);
       offset += batchSize;
       hasMore = data.length === batchSize;
     } else {
       hasMore = false;
     }
   }
   ```

3. **Use specific column selection** when only needing metadata:
   ```typescript
   // To get distinct years efficiently
   const { data } = await supabase
     .from('transactions')
     .select('year');
   ```

### TypeScript Type Mappings

#### Transaction
```typescript
interface SupabaseTransactionRow {
  id: string;
  user_id: string;
  date: string;
  year: number;
  month: number;
  day: number;
  primary_category: string;
  secondary_category: string | null;
  tertiary_category: string;
  amount: number;
  type: 'income' | 'expense' | 'transfer';
  account: string;
  currency: string;
  tags: string[];
  note: string | null;
  raw_index: number | null;
  has_secondary_mapping: boolean;
  created_at: string;
}
```

#### Financial Product
```typescript
interface FinancialProductRow {
  id: string;
  user_id: string;
  name: string;
  code: string | null;
  channel: string | null;
  category: string | null;
  currency: 'CNY' | 'USD' | 'HKD';
  lock_period_days: number;
  annual_return_rate: number | null;
  created_at: string;
}
```

#### Capital Unit
```typescript
interface CapitalUnitRow {
  id: string;
  user_id: string;
  unit_code: string;
  amount: string;  // numeric type comes as string
  currency: string;
  status: '已成立' | '计划中' | '筹集中' | '已归档';
  strategy: string | null;
  tactics: string | null;
  product_id: string | null;
  start_date: string | null;
  end_date: string | null;
  created_at: string;
}
```

#### Settings
```typescript
interface SettingsRow {
  id: number;
  created_at: string;
  owner_id: string | null;
  site_name: string;
  settings: {
    colorScheme?: 'default' | 'swapped';
    activeIncome?: { enabled: boolean; categories: string[] };
    savingsRate?: { includeActiveIncome: boolean };
  };
}
```

---

## Migration Files

The database schema is managed through migration files in `supabase/migrations/`:

- `20250101000000_initial_schema.sql` - Complete initial schema with:
  - All tables (transactions, settings, financial_products, capital_units)
  - RLS policies (15 policies across 4 tables)
  - Functions (get_units_with_products)
  - **Secure permissions** (no anon access, authenticated only)

**Note**: The initial schema already includes all security fixes. No additional migrations needed for new deployments.

To apply migrations:
```bash
supabase db reset  # Local development
supabase db push   # Push to remote
```

---

## Environment Configuration

Configure environment variables in `.env.local`:

```env
VITE_SUPABASE_URL=https://ovglfjkumvzxyhklohst.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

---

## Security Configuration

### Role Permissions

The database follows Supabase security best practices with role-based access control:

| Role | Description | Permissions |
|------|-------------|-------------|
| `anon` | Unauthenticated users (using anon key) | USAGE on schema only - NO table access |
| `authenticated` | Logged-in users | Full CRUD (limited by RLS to own data) |
| `service_role` | Backend service (bypasses RLS) | Full access |

### Row Level Security (RLS)

All 4 tables have RLS enabled with policies enforcing `auth.uid()` based access:

```sql
-- Example: transactions table
ALTER TABLE "public"."transactions" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own transactions"
  ON "public"."transactions" FOR SELECT
  USING ("auth"."uid"() = "user_id");
```

**Security Summary**:
- ✅ All tables have RLS enabled
- ✅ All policies use `auth.uid()` for data isolation
- ✅ `anon` role has NO table/function/sequence permissions
- ✅ Default privileges do NOT grant to `anon`
- ✅ `authenticated` role has full access (RLS-controlled)

### Security Audit

Last audit: **2025-01-01** - ✅ All security issues resolved

See `docs/SECURITY_AUDIT_REPORT.md` for detailed audit history.
