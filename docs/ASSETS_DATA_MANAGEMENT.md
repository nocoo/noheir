# èµ„äº§æ•°æ®ç»Ÿä¸€ç®¡ç†æ–¹æ¡ˆ

## è®¾è®¡ç†å¿µ

**æ ¸å¿ƒåŸåˆ™**ï¼šåœ¨æ•´ä¸ªåº”ç”¨ä¸­ç»´æŠ¤ä¸€ä»½æ•°æ®æºï¼Œæ‰€æœ‰é¡µé¢å…±äº«ç›¸åŒçš„æ•°æ®å’Œç¼“å­˜ã€‚

## æ¶æ„è®¾è®¡

```
App
â””â”€â”€ AssetsDataProvider (Context)
    â”œâ”€â”€ React Query Cache (ç»Ÿä¸€ç¼“å­˜)
    â”‚   â”œâ”€â”€ products (5åˆ†é’Ÿç¼“å­˜)
    â”‚   â”œâ”€â”€ units (è‡ªåŠ¨ç¼“å­˜)
    â”‚   â””â”€â”€ dashboard (è‡ªåŠ¨ç¼“å­˜)
    â””â”€â”€ å„é¡µé¢ç»„ä»¶
        â”œâ”€â”€ ProductsLibrary â†’ useProductsData()
        â”œâ”€â”€ CapitalUnitsManager â†’ useUnitsData()
        â”œâ”€â”€ CapitalDashboard â†’ useAssetsData()
        â””â”€â”€ WarehouseView â†’ useUnitsData()
```

## ä½¿ç”¨æ–¹æ³•

### 1. åœ¨ App.tsx ä¸­åŒ…è£¹ Provider

```tsx
import { AssetsDataProvider } from '@/contexts/AssetsDataContext';

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <SettingsProvider>
          <AssetsDataProvider> {/* ğŸ‘ˆ æ·»åŠ è¿™é‡Œ */}
            <TooltipProvider>
              <Toaster />
              <Sonner />
              <BrowserRouter>
                <Routes>
                  <Route path="/" element={<Index />} />
                  <Route path="*" element={<NotFound />} />
                </Routes>
              </BrowserRouter>
            </TooltipProvider>
          </AssetsDataProvider>
        </SettingsProvider>
      </AuthProvider>
    </QueryClientProvider>
  );
}
```

### 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

#### æ–¹å¼Aï¼šä½¿ç”¨å®Œæ•´æ•°æ®

```tsx
import { useAssetsData } from '@/contexts/AssetsDataContext';

function MyComponent() {
  const { products, units, isLoading, isReady } = useAssetsData();

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (!isReady) return <div>æ•°æ®æœªå°±ç»ª</div>;

  return (
    <div>
      <p>äº§å“æ•°ï¼š{products?.length}</p>
      <p>èµ„é‡‘å•å…ƒæ•°ï¼š{units?.length}</p>
    </div>
  );
}
```

#### æ–¹å¼Bï¼šä½¿ç”¨éƒ¨åˆ†æ•°æ®

```tsx
import { useProductsData } from '@/contexts/AssetsDataContext';

function ProductsList() {
  const { products, isLoading } = useProductsData();

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;

  return (
    <div>
      {products?.map(p => (
        <div key={p.id}>{p.name}</div>
      ))}
    </div>
  );
}
```

#### æ–¹å¼Cï¼šç»§ç»­ä½¿ç”¨ç°æœ‰ Hooksï¼ˆå…¼å®¹ï¼‰

```tsx
// æ—§ä»£ç ä»ç„¶å¯ä»¥å·¥ä½œ
import { useProducts, useUnitsDisplay } from '@/hooks/useAssets';

function LegacyComponent() {
  const { data: products } = useProducts();
  const { data: units } = useUnitsDisplay();

  // ...
}
```

## ä¼˜åŠ¿

### 1. **æ•°æ®ä¸€è‡´æ€§**
- âœ… æ‰€æœ‰é¡µé¢çœ‹åˆ°çš„æ˜¯åŒä¸€ä»½æ•°æ®
- âœ… ä¿®æ”¹åè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰é¡µé¢
- âœ… React Query è‡ªåŠ¨å¤„ç†ç¼“å­˜å¤±æ•ˆ

### 2. **æ€§èƒ½ä¼˜åŒ–**
- âœ… åªè¯·æ±‚ä¸€æ¬¡æ•°æ®ï¼Œå…¨å±€å…±äº«
- âœ… 5åˆ†é’Ÿç¼“å­˜æ—¶é—´ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- âœ… è‡ªåŠ¨å»é‡ç›¸åŒè¯·æ±‚

### 3. **ä»£ç ç®€æ´**
- âœ… ä¸éœ€è¦åœ¨æ¯ä¸ªç»„ä»¶ä¸­å†™é‡å¤çš„ hooks
- âœ… ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†
- âœ… ç±»å‹å®‰å…¨

### 4. **æ˜“äºç»´æŠ¤**
- âœ… é›†ä¸­çš„æ•°æ®è·å–é€»è¾‘
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… æ–¹ä¾¿æ·»åŠ å…¨å±€åˆ·æ–°ç­‰åŠŸèƒ½

## æ•°æ®æ›´æ–°ç­–ç•¥

### è‡ªåŠ¨å¤±æ•ˆï¼ˆReact Queryï¼‰

```tsx
// åœ¨ mutation æˆåŠŸåè‡ªåŠ¨åˆ·æ–°
const createMutation = useMutation({
  mutationFn: createProduct,
  onSuccess: () => {
    // React Query ä¼šè‡ªåŠ¨ä½¿ç¼“å­˜å¤±æ•ˆ
    // æ‰€æœ‰ä½¿ç”¨è¯¥æ•°æ®çš„ç»„ä»¶éƒ½ä¼šè‡ªåŠ¨æ›´æ–°
  },
});
```

### æ‰‹åŠ¨åˆ·æ–°

```tsx
const { refetch } = useAssetsData();

// åˆ·æ–°æ‰€æœ‰æ•°æ®
await refetch();
```

## è¿ç§»æŒ‡å—

### é˜¶æ®µ1ï¼šæ·»åŠ  Providerï¼ˆéç ´åæ€§ï¼‰

1. åœ¨ `App.tsx` ä¸­æ·»åŠ  `AssetsDataProvider`
2. ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ç°æœ‰ç»„ä»¶
3. æ‰€æœ‰åŠŸèƒ½ç»§ç»­æ­£å¸¸å·¥ä½œ

### é˜¶æ®µ2ï¼šé€æ­¥è¿ç§»ï¼ˆå¯é€‰ï¼‰

1. æ–°ç»„ä»¶ä¼˜å…ˆä½¿ç”¨ `useAssetsData()`
2. æ—§ç»„ä»¶ä¿æŒä¸å˜ï¼Œç»§ç»­ä½¿ç”¨ `useProducts()` ç­‰
3. æ¸è¿›å¼è¿ç§»ï¼Œæ— é£é™©

### é˜¶æ®µ3ï¼šå®Œå…¨è¿ç§»ï¼ˆå¯é€‰ï¼‰

1. å°†æ‰€æœ‰ç»„ä»¶è¿ç§»åˆ° `useAssetsData()`
2. ç§»é™¤æ—§çš„ hooks è°ƒç”¨
3. ç®€åŒ–ä»£ç 

## å®ç°ç»†èŠ‚

### ç¼“å­˜é…ç½®

```tsx
// Products - 5åˆ†é’Ÿç¼“å­˜
useQuery({
  queryKey: ['assets', 'products'],
  queryFn: fetchProducts,
  staleTime: 5 * 60 * 1000,
});

// Units - è‡ªåŠ¨ç¼“å­˜
useQuery({
  queryKey: ['assets', 'units', 'display'],
  queryFn: fetchUnitsDisplay,
  // é»˜è®¤ staleTime: 0ï¼Œä¼šè‡ªåŠ¨é‡æ–°è·å–
});

// Dashboard - è‡ªåŠ¨ç¼“å­˜
useQuery({
  queryKey: ['assets', 'capitalOverview'],
  queryFn: fetchCapitalOverview,
});
```

### Query Keys

```tsx
export const assetQueryKeys = {
  allProducts: ['assets', 'products'],
  product: (id: string) => ['assets', 'products', id],
  allUnits: ['assets', 'units'],
  unitsDisplay: ['assets', 'units', 'display'],
  capitalOverview: ['assets', 'capitalOverview'],
};
```

## å¸¸è§é—®é¢˜

### Q: ä¼šå½±å“ç°æœ‰ä»£ç å—ï¼Ÿ
A: ä¸ä¼šã€‚è¿™æ˜¯çº¯æ·»åŠ çš„æ–¹æ¡ˆï¼Œä¸ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç ã€‚

### Q: æ€§èƒ½ä¼šå˜å·®å—ï¼Ÿ
A: ä¸ä¼šã€‚React Query ä¼šè‡ªåŠ¨ç¼“å­˜å’Œå»é‡ï¼Œæ€§èƒ½åè€Œæ›´å¥½ã€‚

### Q: å¿…é¡»è¿ç§»æ‰€æœ‰ç»„ä»¶å—ï¼Ÿ
A: ä¸å¿…é¡»ã€‚å¯ä»¥é€æ­¥è¿ç§»ï¼Œæ–°æ—§ä»£ç å¯ä»¥å…±å­˜ã€‚

### Q: æ•°æ®ä¼šè¿‡æœŸå—ï¼Ÿ
A: Products ç¼“å­˜5åˆ†é’Ÿï¼ŒUnits å’Œ Dashboard æ¯æ¬¡è®¿é—®æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥æ›´æ–°ã€‚

## æœªæ¥æ‰©å±•

å¯ä»¥è½»æ¾æ·»åŠ ï¼š

```tsx
// å…¨å±€åˆ·æ–°æŒ‰é’®
function RefreshButton() {
  const { refetch, isLoading } = useAssetsData();
  return <Button onClick={refetch} disabled={isLoading}>åˆ·æ–°</Button>;
}

// æ•°æ®ç»Ÿè®¡
function DataStats() {
  const { products, units } = useAssetsData();
  return <div>å…± {products?.length} ä¸ªäº§å“ï¼Œ{units?.length} ä¸ªå•å…ƒ</div>;
}

// è‡ªåŠ¨åˆ·æ–°
useEffect(() => {
  const interval = setInterval(() => {
    refetch();
  }, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
  return () => clearInterval(interval);
}, [refetch]);
```

## æµåŠ¨æ€§åˆ†çº§ç³»ç»Ÿ

### è®¾è®¡ç†å¿µ

èµ„é‡‘ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒç›®æ ‡æ˜¯å¹³è¡¡**æµåŠ¨æ€§**å’Œ**æ”¶ç›Šç‡**ã€‚é”å®šæœŸè¶Šé•¿çš„äº§å“é€šå¸¸æ”¶ç›Šç‡è¶Šé«˜ï¼Œä½†æµåŠ¨æ€§è¶Šå·®ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ ¹æ®èµ„é‡‘çš„"å¯ç”¨æ€§"å’Œ"æ”¶ç›ŠçŠ¶æ€"å°†å…¶åˆ†ä¸ºä¸‰ä¸ªç­‰çº§ï¼š

### ä¸‰çº§æµåŠ¨æ€§åˆ†çº§

#### âœ… ä¸€çº§ï¼ˆæœ€ä½³ï¼‰- å·²è¿‡é”å®šæœŸ
**ç‰¹å¾**ï¼š
- é”å®šæœŸå·²è¿‡ï¼ˆ`end_date < ä»Šå¤©`ï¼‰
- èµ„é‡‘**å¯ç”¨äºå†é…ç½®**ï¼ˆçµæ´»ï¼‰
- åŒæ—¶**æŒç»­äº§ç”Ÿæ”¶ç›Š**ï¼ˆä¸æŸå¤±æ”¶ç›Šï¼‰
- **çŠ¶æ€**ï¼š`is_available = true`

**æ˜¾ç¤º**ï¼š
- æ ‡ç­¾ï¼š`å·²å¯ç”¨`
- é¢œè‰²ï¼š`text-income`ï¼ˆç»¿è‰²ï¼‰
- æ–‡æœ¬ï¼š`å·²å¯ç”¨ X å¤©`

**ä¼˜åŠ¿**ï¼šè¿™æ˜¯æœ€ç†æƒ³çš„çŠ¶æ€ï¼Œå…¼é¡¾äº†æ”¶ç›Šæ€§å’ŒæµåŠ¨æ€§

---

#### âš ï¸ äºŒçº§ï¼ˆä¸­ç­‰ï¼‰- é”å®šæœŸå†…
**ç‰¹å¾**ï¼š
- ä»åœ¨é”å®šæœŸï¼ˆ`end_date > ä»Šå¤©`ï¼‰
- èµ„é‡‘**é”å®šä¸å¯ç”¨**ï¼ˆæµåŠ¨æ€§å·®ï¼‰
- ä½†**æ­£åœ¨äº§ç”Ÿæ”¶ç›Š**ï¼ˆæ”¶ç›Šç‡é«˜ï¼‰
- **çŠ¶æ€**ï¼š`is_available = false`

**æ˜¾ç¤º**ï¼š
- æ ‡ç­¾ï¼š`é”å®šæœŸ` / `å³å°†è§£é”`ï¼ˆâ‰¤7å¤©ï¼‰
- é¢œè‰²ï¼šé»˜è®¤ / æ©™è‰²ï¼ˆå³å°†è§£é”ï¼‰
- æ–‡æœ¬ï¼š`X å¤©åè§£é”` / `ä»Šæ—¥è§£é”`

**æƒè¡¡**ï¼šç‰ºç‰²æµåŠ¨æ€§æ¢å–æ›´é«˜æ”¶ç›Š

---

#### âŒ ä¸‰çº§ï¼ˆæœ€å·®ï¼‰- å®Œå…¨é—²ç½®
**ç‰¹å¾**ï¼š
- æ²¡æœ‰å…³è”ä»»ä½•äº§å“ï¼ˆ`product_id = null`ï¼‰
- èµ„é‡‘**å®Œå…¨é—²ç½®**ï¼ˆä¸äº§ç”Ÿæ”¶ç›Šï¼‰
- åŒæ—¶**å¯ç”¨æ€§ä¸ºé›¶**ï¼ˆéœ€æ‰‹åŠ¨é…ç½®ï¼‰

**æ˜¾ç¤º**ï¼š
- æ ‡ç­¾ï¼š`å·²æˆç«‹`ï¼ˆæ— äº§å“æç¤ºï¼‰
- é¢œè‰²ï¼šé»˜è®¤
- æ–‡æœ¬ï¼š`æ— äº§å“`

**åŠ£åŠ¿**ï¼šæ—¢æ— æ”¶ç›Šä¹Ÿæ— é…ç½®è§„åˆ’ï¼Œéœ€è¦å°½å¿«å¤„ç†

---

### è®¡ç®—é€»è¾‘

```typescript
// 1. è®¡ç®— end_date (é”å®šæœŸç»“æŸæ—¥)
end_date = start_date + product.lock_period_days

// 2. è®¡ç®—å‰©ä½™å¤©æ•°
days_until_maturity = end_date - ä»Šå¤©

// 3. åˆ¤æ–­æ˜¯å¦å·²å¯ç”¨
is_available = days_until_maturity < 0  // è´Ÿæ•°è¡¨ç¤ºå·²è¿‡é”å®šæœŸ
```

**é‡è¦**ï¼š
- `is_available = true` ä¸ä»£è¡¨"é€¾æœŸ"æˆ–"åè´¦"
- å®ƒä»£è¡¨**æœ€ä½³æµåŠ¨æ€§çŠ¶æ€**ï¼ˆèµ„é‡‘å¯ç”¨ + æŒç»­æ”¶ç›Šï¼‰
- é”å®šæœŸè¿‡åï¼Œäº§å“ä»ä¼šäº§ç”Ÿåˆ©æ¯ï¼Œç›´åˆ°ç”¨æˆ·ä¸»åŠ¨èµå›

---

### UI æ˜¾ç¤ºè§„åˆ™

#### CapitalUnitsManagerï¼ˆèµ„é‡‘å•å…ƒç®¡ç†è¡¨ï¼‰

| æµåŠ¨æ€§ç­‰çº§ | æ ‡ç­¾ | é¢œè‰² | æ–‡æœ¬ç¤ºä¾‹ |
|-----------|------|------|---------|
| âœ… å·²å¯ç”¨ | `å·²å¯ç”¨` | `text-income`ï¼ˆç»¿ï¼‰ | `å·²å¯ç”¨ 45 å¤©` |
| âš ï¸ å³å°†è§£é” | `å³å°†è§£é”` | `text-orange-500`ï¼ˆæ©™ï¼‰ | `ä»Šæ—¥è§£é”` / `3 å¤©åè§£é”` |
| âš ï¸ é”å®šæœŸ | `é”å®šæœŸ` | é»˜è®¤ | `60 å¤©åè§£é”` |
| âŒ æ— äº§å“ | `å·²æˆç«‹` | é»˜è®¤ | `æ— äº§å“` |

#### WarehouseWaffleChartï¼ˆåå¤«é¥¼å›¾ï¼‰

- å·²è¿‡é”å®šæœŸçš„å•å…ƒæ˜¾ç¤ºä¸º `idle`ï¼ˆé—²ç½®/å¯ç”¨ï¼‰
- Tooltip æ˜¾ç¤ºï¼š`âœ… å·²å¯ç”¨ X å¤©`ï¼ˆç»¿è‰²ï¼‰

#### CapitalDashboardï¼ˆä»ªè¡¨ç›˜ï¼‰

- "åˆ°æœŸæ—¥åˆ†å¸ƒ"å›¾è¡¨å°†å·²å¯ç”¨èµ„é‡‘å½’å…¥"å·²åˆ°æœŸ"æ¡¶
- ä»ªè¡¨ç›˜æç¤ºï¼šæ˜¾ç¤ºä¸ºæœ€ä½³çŠ¶æ€

#### CapitalDecisionsï¼ˆèµ„é‡‘å†³ç­–ï¼‰

- å·²å¯ç”¨èµ„é‡‘ï¼š`urgency = 'low'`ï¼ˆæ— éœ€ç´§æ€¥å¤„ç†ï¼‰
- å³å°†è§£é”ï¼ˆâ‰¤7å¤©ï¼‰ï¼š`urgency = 'high'`ï¼ˆéœ€è§„åˆ’å†é…ç½®ï¼‰

---

### æœ¯è¯­å¯¹ç…§è¡¨

| æ—§æœ¯è¯­ | æ–°æœ¯è¯­ | è¯´æ˜ |
|-------|--------|------|
| `is_overdue` | `is_available` | æ›´å‡†ç¡®åæ˜ "å¯ç”¨"è€Œé"é€¾æœŸ" |
| "é€¾æœŸ X å¤©" | "å·²å¯ç”¨ X å¤©" | å¼ºè°ƒè¿™æ˜¯**æœ€ä½³çŠ¶æ€** |
| "å‰©ä½™å¤©æ•°" | "è§£é”è¿›åº¦" | å¼ºè°ƒ"è§£é”"è€Œé"å€’è®¡æ—¶" |
| "ä»Šæ—¥åˆ°æœŸ" | "ä»Šæ—¥è§£é”" | æ›´ç§¯æçš„è¡¨è¿° |
| "å·²åˆ°æœŸ" | "å·²å¯ç”¨" | é¿å…è´Ÿé¢è”æƒ³ |

---

### è®¾è®¡å“²å­¦

è¿™ä¸ªç³»ç»ŸåŸºäºä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. **æ”¶ç›Šä¼˜å…ˆ**ï¼šå·²è¿‡é”å®šæœŸçš„èµ„é‡‘ä»åœ¨äº§ç”Ÿæ”¶ç›Šï¼Œä¸æ˜¯"é—®é¢˜"
2. **æµåŠ¨æ€§ç®¡ç†**ï¼šé€šè¿‡é¢œè‰²å’Œæ ‡ç­¾å¿«é€Ÿè¯†åˆ«èµ„é‡‘å¯ç”¨æ€§
3. **æ­£å‘å¼•å¯¼**ï¼šä½¿ç”¨"å·²å¯ç”¨"ã€"è§£é”"ç­‰ç§¯æè¯æ±‡ï¼Œè€Œé"é€¾æœŸ"
4. **å†³ç­–æ”¯æŒ**ï¼šå¸®åŠ©ç”¨æˆ·åœ¨æµåŠ¨æ€§å’Œæ”¶ç›Šä¹‹é—´åšå‡ºæ˜æ™ºé€‰æ‹©

---

### ä¿®æ”¹å†å²

- **2025-01-02**: å°† `is_overdue` é‡å‘½åä¸º `is_available`ï¼Œæ›´æ–°æ‰€æœ‰UIç»„ä»¶çš„æ˜¾ç¤ºé€»è¾‘å’Œæœ¯è¯­
